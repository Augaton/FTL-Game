name: üöÄ Build, Tag & Publish

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Num√©ro de version (ex: v1.0)'
        required: true
        default: 'v1.0'
      message:
        description: 'Description courte de la mise √† jour'
        required: false
        default: 'Mise √† jour automatique via GitHub Actions'

permissions:
  contents: write # Indispensable pour cr√©er le Tag et la Release

jobs:
  # ======================================================
  # PHASE 1 : PR√âPARATION & V√âRIFICATION
  # ======================================================
  preparation:
    name: üîç Check Integrity
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code
        uses: actions/checkout@v4

      - name: V√©rification de pr√©sence des fichiers cl√©s
        run: |
          if [ ! -f main.c ]; then echo "‚ùå CRITIQUE: main.c introuvable !"; exit 1; fi
          if [ ! -f combat.c ]; then echo "‚ùå CRITIQUE: combat.c introuvable !"; exit 1; fi
          echo "‚úÖ Fichiers source pr√©sents. Pr√™t pour la compilation."

  # ======================================================
  # PHASE 2 : BUILD (LINUX & WINDOWS EN PARALL√àLE)
  # ======================================================
  build-linux:
    name: üêß Build Linux
    needs: preparation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Compilation GCC (Linux)
        # -lm est vital pour math.h sous Linux
        run: gcc *.c -o FTL_Linux -lm -Wall 
        
      - name: Upload Artifact Linux
        uses: actions/upload-artifact@v4
        with:
          name: binary-linux
          path: FTL_Linux

  build-windows:
    name: ü™ü Build Windows
    needs: preparation
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Compilation GCC (Windows/MinGW)
        run: gcc *.c -o FTL_Windows.exe -Wall
        
      - name: Upload Artifact Windows
        uses: actions/upload-artifact@v4
        with:
          name: binary-windows
          path: FTL_Windows.exe

  # ======================================================
  # PHASE 3 : CR√âATION DU TAG ET RELEASE
  # ======================================================
  release:
    name: üì¶ Create Release & Tag
    # CONDITION : Ne se lance que si Linux ET Windows ont r√©ussi
    needs: [build-linux, build-windows] 
    runs-on: ubuntu-latest
    steps:
      - name: R√©cup√©ration du code (Pour le zip source)
        uses: actions/checkout@v4

      # 1. T√©l√©chargement des ex√©cutables compil√©s
      - name: Download Linux Binary
        uses: actions/download-artifact@v4
        with:
          name: binary-linux
          
      - name: Download Windows Binary
        uses: actions/download-artifact@v4
        with:
          name: binary-windows

      # 2. Cr√©ation d'une archive propre du code source (sans le dossier .git)
      - name: Zip Source Code
        run: zip -r FTL_Source_Code.zip . -x "*.git*" "*.github*"

      # 3. Cr√©ation automatique du Tag Git
      - name: Create Git Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag ${{ inputs.version }}
          git push origin ${{ inputs.version }}

      # 4. Publication de la Release
      - name: Publish GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ inputs.version }}
          name: Release ${{ inputs.version }}
          body: |
            ## üöÄ FTL Console - ${{ inputs.version }}
            ${{ inputs.message }}
            
            ### üì• T√©l√©chargements :
            - **Windows** : `FTL_Windows.exe`
            - **Linux/Mac** : `FTL_Linux`
            - **Code Source** : `FTL_Source_Code.zip`
            
            _Compil√© automatiquement par GitHub Actions._
          files: |
            FTL_Windows.exe
            FTL_Linux
            FTL_Source_Code.zip
          draft: false
          prerelease: false